Unified Knowledge RAG (SiYuan + MCP)
Обновлённое описание проекта на 24.10.2025

Идея и назначение
Unified Knowledge RAG — это личная база знаний поверх SiYuan, которая одновременно:
- служит высокоточной RAG/GraphRAG‑памятью для внешних LLM и агентов;
- предоставляет единый MCP‑сервер с инструментами поиска, извлечения и навигации по графу знаний;
- работает приватно «по умолчанию», с объяснимостью результатов, поддержкой ru/en и быстрыми кэшированными ответами.

Ценность для пользователя
- Исследователь видит эволюцию идей, цепочки обоснований и подграфы «как есть» из своих заметок.
- Разработчик мгновенно находит фрагменты кода, переходя к точному месту в SiYuan.
- Писатель формирует карты смысловых связей и экспортирует их.
- Студент получает персональные объяснения и само‑тесты.
- Агент/LLM получает строго обоснованные пассейджи и подграфы через MCP‑tools, с точными цитатами и ссылками на блоки.

Ключевые цели
- «Источник правды» — все знания живут в SiYuan; индексация и граф строятся поверх блоков.
- Объяснимость — каждый ответ сопровождается цитатами, путями по графу и confidence‑оценкой.
- Производительность на VPS 4 vCPU / 8 GB RAM — быстрый гибридный поиск и дешёвые CPU‑модели.
- Приватность — «только локальные данные» по умолчанию; наружу уходит лишь то, что вы явно разрешили.

Пользовательские сценарии (поддерживаются из коробки)
- Поиск и выдача: единый гибридный поиск (FTS5 + векторы + переранжирование), топ‑15, сниппеты, релевантность, confidence, кэш‑статус и дата.
- Переходы и цитирование: точные цитаты к блокам SiYuan с точностью по символам p95 ≥ 98%.
- Граф знаний: подграфы на 1–3 хопа, типы связей (родитель/ребёнок, цитирует/цитируется, ко‑упоминание, семантический сосед), визуализация и экспорт снимков графа.
- Таймлайн: просмотр эволюции идей/документов по времени, группировка и фильтры.
- Коллекции и история: сохранение сетов результатов, повторные запуски, экспорт.
- Self‑test: генерация MCQ, cloze и коротких ответов по выбранной области с привязкой к источникам.
- Экспорт: JSON/Markdown с сохранением форматирования и ссылок, PDF с ≥95% сохранения форматирования и всеми гиперссылками.
- MCP‑доступ для агентов: поиск, извлечение пассейджей, подграфы, таймлайны, сохранение коллекций, открытие блоков в SiYuan.

MCP: инструменты, ресурсы, безопасность
- Инструменты: search_knowledge, retrieve_passages, retrieve_graph, get_timeline, save_collection, ingest_resource, open_in_siyuan, generate_selftest, get_context_profile, health.
- Ресурсы/стримы: results/{session_id}, events/index_updates.
- Безопасность: scopes read:notes, read:graph, write:collections, ingest, open:editor; токены на стороне клиента; аудит вызовов.
- Протокол: сервер поддерживает потоковую выдачу и пагинацию контекста под лимиты токенов.

Retrieval/Memory API для LLM
- Форматы: Passages; Graph bundle (подграф + доказательная база); Hybrid.
- Параметры: top_k, filters, lang, режимы bm25/dense/hybrid/graph/multi‑hop, rerank, dedup, diversity (MMR).
- GroundedAnswer: answer (опционально), passages[], graph{}, confidence_calibrated, trace по запросу.

GraphRAG пайплайн
- Извлечение: сущности (персоны, понятия, задачи, артефакты, источники) и отношения (цитирует, принадлежит, использует, противопоставляет, ко‑упоминание).
- Источники связей: структура SiYuan, внутренние ссылки и цитаты, якорные теги, временные метки.
- Хранение: компактные таблицы nodes/edges/evidence с FTS‑поиском по меткам и алиасам.
- Запросы: подграф по seed, k‑hops, временные срезы, ранжирование путей, экспорт GraphJSON/PNG/SVG.

Однозначно определённый технологический стек (prod, пины)
- Базовая платформа: Ubuntu Server 24.04 LTS.
- Язык и API: Python 3.13.0; FastAPI 0.119.1; Uvicorn 0.38.0 (профиль standard с uvloop/httptools).
- Инференс/численные: ONNX Runtime 1.23.1; NumPy 2.1.2.
- Поиск и хранилища:
  - SQLite 3.50.4, FTS5 с detail=full и xInstToken для точных оффсетов.
  - Qdrant 1.15.5, HNSW (M=24, ef_construct=128, ef_search=96), scalar int8 quantization, payload‑индексы для фильтров.
- Реверс‑прокси и TLS: Traefik 3.5.0.
- SiYuan: 3.3.5 (минимум 3.1.19+ из‑за закрытия уязвимости; API‑доступ не публиковать наружу).
- UI плагина: TypeScript 5.x, Preact, Vite 5.x.
- Модели (CPU‑friendly, ru/en):
  - Эмбеддинги: Alibaba‑NLP gte‑multilingual‑base, размерность 768, ONNX INT8.
  - Переранкер: BAAI bge‑reranker‑v2‑m3, ONNX INT8.
- Внешние LLM (по приоритету и как fallback‑цепочка): Google AI Studio (Gemini 2.5 Flash), Groq, OpenRouter.

Архитектура и модули
- Core Retrieval: индексаторы FTS5 и векторов, RRF‑слияние, CPU‑переранкер, кэш горячих результатов, калибровка confidence.
- Graph Builder/Store: извлечение сущностей/связей из блоков, хранение графа, API подграфов/путей/объяснений.
- Query Orchestrator: маршрутизация режимов hybrid/graph/multi‑hop, агрегирование сигналов (BM25, cosine, rerank), dedup/diversity.
- SiYuan Integration: плагин с панелью поиска, графом, таймлайном, коллекциями, переходами по block ID, локализацией ru/en.
- MCP Adapter: сервер инструментов/ресурсов с scopes, потоковыми ответами, пагинацией, health и аудитом.
- Export/Collections: сохранение коллекций, история, экспорт JSON/MD/PDF.

Производительность и метрики качества
- SLA/латентности (цели p50/p95):
  - Кэшированные ответы: 60–100 мс / ≤150 мс.
  - Fresh hybrid: 300–700 мс / ≤1.5 с.
  - Подграф 1–2 хопа (≤500 узлов): ≤1 с / ≤2.5 с.
  - E2E с внешним LLM: 2–4 с / ≤7 с.
- Качество поиска: Precision@15 ≥ 0.8, nDCG@15 ≥ 0.85, Recall@100 ≥ 0.9.
- Цитирование: точность по char‑offset p95 ≥ 98% (за счёт FTS5 detail=full + xInstToken и корректного token→char маппинга).
- Кэш: 60–75% повторных запросов из кэша.
- Уверенность: калиброванная doc‑confidence с ECE ≤ 5%; отчёт в виде reliability diagrams.
- UX: успешность задач ≥ 85%; фильтры снижают нерелевантность ≥ 70%; повторные запуски из истории успешны ≥ 95%.

Приватность и безопасность
- Режим «только локальные данные» по умолчанию; внешние вызовы — только по явному разрешению.
- Шифрование «в полёте» через Traefik (TLS) и дисковое шифрование на уровне ОС.
- MCP scopes, токены на стороне клиента, аудит всех инструментов; rate‑limit‑aware ретраи и бэкофы для LLM‑провайдеров.
- Ограничение доступа к SiYuan kernel API извне; минимизация открытых портов.
- Регулярные обновления: удерживать SiYuan ≥ 3.3.5; базовые образы c актуальными патчами.

Docker/Compose: запуск «в одну команду»
- Цель: после подготовки переменных окружения и путей данных проект стартует одной командой: docker compose up ‑d.
- Сервисы в составе стека:
  - API/Orchestrator: FastAPI‑приложение с Retrieval/GraphRAG/MCP в одном контейнере.
  - Indexer/Worker: фоновая индексация и построение графа (отдельный рабочий процесс).
  - Qdrant: отдельный контейнер с постоянным томом для коллекций.
  - Reverse proxy: Traefik с автогенерацией сертификатов и терминатором TLS.
  - (Опционально) Лёгкий журнал/метрики: сервис для экспорта метрик и логов; эндпоинт /metrics готов для подключения Prometheus.
- Данные и тома:
  - Том для Qdrant хранилища.
  - Том для SQLite (индексы, кэш, история).
  - Том для экспорта (JSON/MD/PDF) и артефактов.
- Секреты и переменные:
  - Ключи провайдеров LLM (Google AI Studio, Groq, OpenRouter) хранятся в секретах/переменных окружения; по умолчанию — режим без внешних LLM (остаются пассейджи и подграфы).
- Сетевые настройки:
  - Внутренняя сеть compose для сервисов.
  - Внешние порты: один HTTPS‑порт Traefik; внутренние порты Qdrant и API не публикуются.
- Инсталляция плагина:
  - Плагин SiYuan устанавливается в клиенте SiYuan; указывает URL локального API (через Traefik). После запуска стека плагин готов к работе.
- Обслуживание:
  - Ротация логов контейнеров, периодические бэкапы томов Qdrant/SQLite; health‑checks для всех сервисов.

Точность цитирования и язык
- Для точных переходов к блокам используются FTS5 detail=full и xInstToken, а также нормализация Unicode (NFKC) и маппинг token→char с учётом скрытых символов.
- Автоопределение языка запроса/документа; полноценная поддержка ru/en по всему пайплайну.

Фильтры и деградация
- Фильтры: дата, тип, язык, порог уверенности; сохранение сетов фильтров.
- Гибкая деградация: при недоступности LLM возвращаются обоснованные пассейджи и подграфы; при высоких задержках — кэшированные ответы со статусом fresh/stale и возможностью обновления.

Тестирование и CI
- Юнит/интеграционные тесты: индексатор, ранжирование, граф, MCP‑инструменты.
- Performance‑прогоны: индексация, latency p50/p95, деградация без LLM.
- Оценка качества: офлайн‑корпуса, разметка релевантности, отчёты nDCG/MRR/ECE.
- Совместимость: матрица версий (SiYuan 3.3.5, FastAPI 0.119.1, Qdrant 1.15.5, SQLite 3.50.4, ORT 1.23.1) и бэкаут‑инструкции.

Дорожная карта (минимум)
- М1: Гибридный поиск + плагин SiYuan (поиск, переходы, коллекции), кэш и метрики.
- М2: MCP‑сервер (search/retrieve_passages/open_in_siyuan), экспорт JSON/MD, история.
- М3: GraphRAG (извлечение сущностей/связей, подграф, таймлайн, объяснения), экспорт графа.
- М4: Self‑test генерация, расширенные фильтры, калибровка confidence, отчёты качества.
- М5: Оптимизации p95 (инт8‑эмбеддинги, быстрый переранкер, троттлинг под лимиты провайдеров), безопасность и аудит.

Ограничения и риски
- Нестабильность лимитов «бесплатных» LLM‑моделей у провайдеров — заложены ретраи, бэкофы и fallback‑цепочка.
- MCP‑клиенты (IDE/CLI) могут по‑разному трактовать ресурсы и стримы — предусмотрен понятный fallback через прямой Retrieval/Graph API.
- При росте базы размер векторных коллекций и графа потребует тонкой настройки HNSW и возможного даунсемплинга/квантизации; для 4 vCPU / 8 GB используются параметры и модели, уже оптимизированные под CPU.

Что нужно подготовить до первого запуска
- Директории для данных (тома) и доступ плагина к API.
- Переменные окружения и секреты LLM‑провайдеров (по желанию).
- Установка плагина в SiYuan и указание URL API.
- После этого проект стартует одной командой: docker compose up ‑d.

Этот документ фиксирует архитектуру, стек, фичи и операционную модель проекта в однозначном виде и готов к внедрению на VPS 4 vCPU / 8 GB.